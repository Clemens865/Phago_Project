<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phago Web Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #1a1a2e; color: #e0e0e0; font-family: 'Courier New', monospace; overflow: hidden; }
.container { display: grid; grid-template-columns: 1fr 1fr 300px; grid-template-rows: 1fr 200px 60px; height: 100vh; gap: 2px; background: #0f0f23; }
.panel { background: #1a1a2e; border: 1px solid #333366; border-radius: 4px; overflow: hidden; position: relative; }
.panel-title { position: absolute; top: 4px; left: 8px; font-size: 11px; color: #7777aa; text-transform: uppercase; letter-spacing: 1px; z-index: 10; }
#graph-panel { grid-column: 1; grid-row: 1; }
#agent-panel { grid-column: 2; grid-row: 1; }
#sidebar { grid-column: 3; grid-row: 1 / 3; padding: 12px; overflow-y: auto; }
#events-panel { grid-column: 1 / 3; grid-row: 2; }
#controls { grid-column: 1 / 4; grid-row: 3; display: flex; align-items: center; padding: 8px 16px; gap: 16px; }

.stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #222244; font-size: 12px; }
.stat-label { color: #8888bb; }
.stat-value { color: #ddddff; font-weight: bold; }
.section-title { color: #9999cc; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin: 12px 0 6px 0; }
.legend { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; }

svg { width: 100%; height: 100%; }
.node-label { font-size: 9px; fill: #aaa; pointer-events: none; }
.tooltip { position: absolute; background: #222244; border: 1px solid #444488; padding: 6px 10px; border-radius: 4px; font-size: 11px; pointer-events: none; z-index: 100; display: none; }

h2 { font-size: 14px; color: #bbbbee; margin-bottom: 8px; }
button { background: #333366; border: 1px solid #5555aa; color: #ddddff; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-family: inherit; }
button:hover { background: #444488; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
input[type="text"], textarea { background: #222244; border: 1px solid #444477; color: #ddddff; padding: 6px 10px; border-radius: 4px; font-family: inherit; width: 100%; }
input[type="range"] { flex: 1; accent-color: #5555ff; }

#event-list { max-height: 160px; overflow-y: auto; font-size: 10px; padding: 8px; }
.event-item { padding: 2px 0; border-bottom: 1px solid #222244; }
.event-type { color: #7799cc; }
.event-time { color: #666; font-size: 9px; }

.status-indicator { width: 10px; height: 10px; border-radius: 50%; }
.status-connected { background: #44cc44; }
.status-disconnected { background: #cc4444; }

#query-section { margin-top: 12px; }
#query-input { margin-bottom: 8px; }
#query-results { max-height: 200px; overflow-y: auto; font-size: 11px; }
.result-item { padding: 4px 0; border-bottom: 1px solid #222244; }
.result-label { color: #aaddff; }
.result-score { color: #88aa88; font-size: 10px; }

#ingest-section { margin-top: 12px; }
#ingest-title, #ingest-content { margin-bottom: 8px; }
#ingest-content { min-height: 60px; resize: vertical; }
</style>
</head>
<body>
<div class="container">
  <div class="panel" id="graph-panel">
    <div class="panel-title">Knowledge Graph</div>
    <svg id="graph-svg"></svg>
  </div>
  <div class="panel" id="agent-panel">
    <div class="panel-title">Agent Canvas</div>
    <svg id="agent-svg"></svg>
  </div>
  <div class="panel" id="sidebar">
    <h2>Phago Dashboard</h2>
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
      <div class="status-indicator" id="status-indicator"></div>
      <span id="status-text">Connecting...</span>
    </div>

    <div class="section-title">Agents</div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#44cc44"></div> Digester</div>
      <div class="legend-item"><div class="legend-dot" style="background:#cc4444"></div> Sentinel</div>
      <div class="legend-item"><div class="legend-dot" style="background:#aa44cc"></div> Synthesizer</div>
    </div>

    <div class="section-title">Graph Nodes</div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#4488cc"></div> Concept</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ccaa22"></div> Insight</div>
      <div class="legend-item"><div class="legend-dot" style="background:#cc4444"></div> Anomaly</div>
    </div>

    <div class="section-title">Metrics</div>
    <div id="metrics-panel">
      <div class="stat-row"><span class="stat-label">Tick</span><span class="stat-value" id="m-tick">0</span></div>
      <div class="stat-row"><span class="stat-label">Nodes</span><span class="stat-value" id="m-nodes">0</span></div>
      <div class="stat-row"><span class="stat-label">Edges</span><span class="stat-value" id="m-edges">0</span></div>
      <div class="stat-row"><span class="stat-label">Agents</span><span class="stat-value" id="m-agents">0</span></div>
      <div class="stat-row"><span class="stat-label">Docs</span><span class="stat-value" id="m-docs">0</span></div>
    </div>

    <div class="section-title" id="query-section">Query</div>
    <input type="text" id="query-input" placeholder="Search knowledge graph...">
    <button id="query-btn" onclick="runQuery()">Search</button>
    <div id="query-results"></div>

    <div class="section-title" id="ingest-section">Ingest Document</div>
    <input type="text" id="ingest-title" placeholder="Title">
    <textarea id="ingest-content" placeholder="Document content..."></textarea>
    <button id="ingest-btn" onclick="ingestDocument()">Ingest</button>
  </div>
  <div class="panel" id="events-panel">
    <div class="panel-title">Events</div>
    <div id="event-list"></div>
  </div>
  <div id="controls">
    <button id="tick-btn" onclick="sendTick(1)">Tick</button>
    <button id="run-btn" onclick="sendTick(10)">Run 10</button>
    <button id="run50-btn" onclick="sendTick(50)">Run 50</button>
    <span id="tick-label">Tick 0</span>
    <button id="refresh-btn" onclick="requestSnapshot()">Refresh</button>
  </div>
</div>
<div class="tooltip" id="tooltip"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// State
let snapshot = null;
let ws = null;
let reconnectAttempts = 0;

// DOM elements
const tooltip = document.getElementById('tooltip');
const eventList = document.getElementById('event-list');

function showTooltip(text, x, y) {
  tooltip.style.display = 'block';
  tooltip.textContent = text;
  tooltip.style.left = (x + 10) + 'px';
  tooltip.style.top = (y - 20) + 'px';
}
function hideTooltip() { tooltip.style.display = 'none'; }

// WebSocket connection
function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${protocol}//${window.location.host}/ws/events`);

  ws.onopen = () => {
    reconnectAttempts = 0;
    updateStatus(true);
    console.log('WebSocket connected');
  };

  ws.onclose = () => {
    updateStatus(false);
    console.log('WebSocket disconnected');
    // Reconnect with exponential backoff
    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
    reconnectAttempts++;
    setTimeout(connectWebSocket, delay);
  };

  ws.onerror = (err) => {
    console.error('WebSocket error:', err);
  };

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'snapshot') {
      snapshot = msg.data;
      updateAll();
    } else if (msg.type === 'event') {
      handleEvent(msg.data);
    }
  };
}

function updateStatus(connected) {
  const indicator = document.getElementById('status-indicator');
  const text = document.getElementById('status-text');
  if (connected) {
    indicator.className = 'status-indicator status-connected';
    text.textContent = 'Connected';
  } else {
    indicator.className = 'status-indicator status-disconnected';
    text.textContent = 'Disconnected';
  }
}

function handleEvent(event) {
  // Add to event list
  const eventType = Object.keys(event)[0] || 'Unknown';
  const item = document.createElement('div');
  item.className = 'event-item';
  item.innerHTML = `<span class="event-type">${eventType}</span>`;
  eventList.insertBefore(item, eventList.firstChild);

  // Keep only last 100 events
  while (eventList.children.length > 100) {
    eventList.removeChild(eventList.lastChild);
  }

  // Request snapshot on significant events
  if (event.TickComplete) {
    requestSnapshot();
  }
}

function requestSnapshot() {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ cmd: 'snapshot' }));
  }
}

function sendTick(count) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ cmd: 'tick', count: count }));
  }
}

// Knowledge Graph visualization
const graphSvg = d3.select('#graph-svg');
const graphG = graphSvg.append('g');
let graphSim = null;

function updateGraph() {
  if (!snapshot) return;

  const width = document.getElementById('graph-panel').clientWidth;
  const height = document.getElementById('graph-panel').clientHeight;

  const nodeMap = {};
  snapshot.nodes.forEach((n, i) => { nodeMap[n.label] = i; n.index = i; });

  const links = snapshot.edges
    .filter(e => nodeMap[e.from_label] !== undefined && nodeMap[e.to_label] !== undefined)
    .map(e => ({
      source: nodeMap[e.from_label],
      target: nodeMap[e.to_label],
      weight: e.weight,
      co_activations: e.co_activations
    }));

  const nodeColor = d => {
    if (d.node_type === 'Insight') return '#ccaa22';
    if (d.node_type === 'Anomaly') return '#cc4444';
    return '#4488cc';
  };

  // Links
  const link = graphG.selectAll('line.graph-link').data(links, (d, i) => i);
  link.exit().remove();
  const linkEnter = link.enter().append('line').attr('class', 'graph-link');
  const linkAll = linkEnter.merge(link)
    .attr('stroke', '#334466')
    .attr('stroke-opacity', d => Math.min(d.weight, 0.8))
    .attr('stroke-width', d => Math.max(d.weight * 2, 0.5));

  // Nodes
  const node = graphG.selectAll('circle.graph-node').data(snapshot.nodes, d => d.label);
  node.exit().remove();
  const nodeEnter = node.enter().append('circle').attr('class', 'graph-node')
    .on('mouseover', (ev, d) => showTooltip(`${d.label} (${d.node_type}) access:${d.access_count}`, ev.pageX, ev.pageY))
    .on('mouseout', hideTooltip);
  const nodeAll = nodeEnter.merge(node)
    .attr('r', d => Math.max(3, Math.min(d.access_count * 1.5, 15)))
    .attr('fill', nodeColor)
    .attr('opacity', 0.85);

  // Labels
  const label = graphG.selectAll('text.node-label').data(snapshot.nodes, d => d.label);
  label.exit().remove();
  const labelEnter = label.enter().append('text').attr('class', 'node-label');
  const labelAll = labelEnter.merge(label).text(d => d.label);

  if (graphSim) graphSim.stop();
  graphSim = d3.forceSimulation(snapshot.nodes)
    .force('link', d3.forceLink(links).distance(60))
    .force('charge', d3.forceManyBody().strength(-40))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .on('tick', () => {
      linkAll.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
             .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
      nodeAll.attr('cx', d => d.x).attr('cy', d => d.y);
      labelAll.attr('x', d => d.x + 8).attr('y', d => d.y + 3);
    });
}

// Agent Canvas visualization
const agentSvg = d3.select('#agent-svg');

function updateAgents() {
  if (!snapshot) return;

  const width = document.getElementById('agent-panel').clientWidth;
  const height = document.getElementById('agent-panel').clientHeight;

  // Compute scale from agent positions
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  snapshot.agents.forEach(a => {
    minX = Math.min(minX, a.position.x); maxX = Math.max(maxX, a.position.x);
    minY = Math.min(minY, a.position.y); maxY = Math.max(maxY, a.position.y);
  });

  // Default bounds if no agents
  if (!isFinite(minX)) { minX = 0; maxX = 100; minY = 0; maxY = 100; }

  const pad = 40;
  const rangeX = Math.max(maxX - minX, 1);
  const rangeY = Math.max(maxY - minY, 1);
  const scaleX = d => pad + (d.position.x - minX) / rangeX * (width - 2 * pad);
  const scaleY = d => pad + (d.position.y - minY) / rangeY * (height - 2 * pad);

  const agentColor = d => {
    if (d.agent_type === 'digester') return '#44cc44';
    if (d.agent_type === 'sentinel') return '#cc4444';
    if (d.agent_type === 'synthesizer') return '#aa44cc';
    return '#888888';
  };

  const circ = agentSvg.selectAll('circle.agent').data(snapshot.agents, d => d.id.toString());
  circ.exit().transition().duration(200).attr('r', 0).remove();
  const circEnter = circ.enter().append('circle').attr('class', 'agent')
    .attr('r', 0)
    .on('mouseover', (ev, d) => showTooltip(`${d.agent_type} age:${d.age} perm:${d.permeability.toFixed(2)} vocab:${d.vocabulary_size}`, ev.pageX, ev.pageY))
    .on('mouseout', hideTooltip);
  circEnter.merge(circ).transition().duration(300)
    .attr('cx', scaleX).attr('cy', scaleY)
    .attr('r', 10)
    .attr('fill', agentColor)
    .attr('opacity', d => 0.3 + (1.0 - d.permeability) * 0.7)
    .attr('stroke', '#ffffff22').attr('stroke-width', 1);

  // Labels
  const lbl = agentSvg.selectAll('text.agent-label').data(snapshot.agents, d => d.id.toString());
  lbl.exit().remove();
  const lblEnter = lbl.enter().append('text').attr('class', 'agent-label')
    .attr('font-size', '9px').attr('fill', '#888');
  lblEnter.merge(lbl).transition().duration(300)
    .attr('x', d => scaleX(d) + 12).attr('y', d => scaleY(d) + 3)
    .text(d => d.agent_type.slice(0, 3));
}

// Metrics update
function updateMetrics() {
  if (!snapshot) return;

  document.getElementById('m-tick').textContent = snapshot.tick;
  document.getElementById('m-nodes').textContent = snapshot.stats.graph_nodes;
  document.getElementById('m-edges').textContent = snapshot.stats.graph_edges;
  document.getElementById('m-agents').textContent = snapshot.stats.agents_alive;
  document.getElementById('m-docs').textContent = `${snapshot.stats.documents_digested}/${snapshot.stats.documents_total}`;
  document.getElementById('tick-label').textContent = `Tick ${snapshot.tick}`;
}

// Update all visualizations
function updateAll() {
  updateGraph();
  updateAgents();
  updateMetrics();
}

// Query functionality
async function runQuery() {
  const query = document.getElementById('query-input').value;
  if (!query) return;

  const response = await fetch('/api/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, max_results: 10, alpha: 0.5 })
  });

  const data = await response.json();
  const resultsDiv = document.getElementById('query-results');
  resultsDiv.innerHTML = data.results.map(r =>
    `<div class="result-item">
      <span class="result-label">${r.label}</span>
      <span class="result-score">(${r.score.toFixed(3)})</span>
    </div>`
  ).join('');
}

// Ingest functionality
async function ingestDocument() {
  const title = document.getElementById('ingest-title').value;
  const content = document.getElementById('ingest-content').value;
  if (!title || !content) return;

  document.getElementById('ingest-btn').disabled = true;

  const response = await fetch('/api/ingest', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, content, ticks: 15 })
  });

  const data = await response.json();
  console.log('Ingested:', data);

  document.getElementById('ingest-title').value = '';
  document.getElementById('ingest-content').value = '';
  document.getElementById('ingest-btn').disabled = false;

  requestSnapshot();
}

// Enter key handlers
document.getElementById('query-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') runQuery();
});

// Initialize
window.addEventListener('resize', updateAll);
connectWebSocket();
</script>
</body>
</html>
